---
phase: 01-model-switching
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/views/ChatView.tsx
autonomous: true
requirements:
  - MODL-01
  - MODL-04

must_haves:
  truths:
    - "A model dropdown appears in the chat input status bar and users can change it before sending"
    - "The selected model override is transmitted with the message via the WebSocket models payload"
    - "The dropdown defaults to the bot's configured default model on load and resets on bot switch"
  artifacts:
    - path: "frontend/src/components/views/ChatView.tsx"
      provides: "Model selector state, ModelSelect embedding, and wsSendMessage override"
      contains: "ModelSelect"
  key_links:
    - from: "frontend/src/components/views/ChatView.tsx"
      to: "frontend/src/components/common/ModelSelect.tsx"
      via: "import and render in status bar"
      pattern: "import.*ModelSelect"
    - from: "frontend/src/components/views/ChatView.tsx"
      to: "wsSendMessage"
      via: "effectiveModels override in handleSend"
      pattern: "models:\\s*effectiveModels"
    - from: "frontend/src/components/views/ChatView.tsx"
      to: "getBotDefaultModel"
      via: "state initialization and bot-switch sync"
      pattern: "getBotDefaultModel"
---

<objective>
Add a per-message model selector dropdown to the chat input area and wire it into the outgoing WebSocket message.

Purpose: Users can pick which AI model handles their next message without changing the bot's global configuration. The selector uses the existing `ModelSelect` component (which already has search, grouping, manual entry) and merges the selection into the `models` dict sent to the backend — where the `bot_models["default"]` override path already works.

Output: Updated `ChatView.tsx` with embedded `ModelSelect` in the status bar, `selectedModel` state synced to the active bot, and `wsSendMessage` call passing the override.
</objective>

<execution_context>
@/home/uan/.claude/get-shit-done/workflows/execute-plan.md
@/home/uan/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-model-switching/01-RESEARCH.md

@frontend/src/components/views/ChatView.tsx
@frontend/src/components/common/ModelSelect.tsx
@frontend/src/stores/bots.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model selector state and embed ModelSelect in ChatView status bar</name>
  <files>frontend/src/components/views/ChatView.tsx</files>
  <action>
In `ChatView.tsx`:

1. **Import ModelSelect** — add `import { ModelSelect } from '../common/ModelSelect'` at the top alongside existing imports. Also import `getBotDefaultModel` from `'../../stores/bots'` (it's already exported there alongside `useBotStore`).

2. **Add selectedModel state** — near the existing state declarations (around line 68), add:
   ```typescript
   const [selectedModel, setSelectedModel] = useState(() => {
     const bot = useBotStore.getState().getActiveBot()
     return bot ? getBotDefaultModel(bot) : ''
   })
   ```

3. **Sync on bot switch** — add a `useEffect` that resets `selectedModel` when `activeBotId` changes:
   ```typescript
   useEffect(() => {
     const bot = useBotStore.getState().getActiveBot()
     setSelectedModel(bot ? getBotDefaultModel(bot) : '')
   }, [activeBotId])
   ```

4. **Replace static model label with ModelSelect** — in the main chat status bar (around line 1214-1228, the second status bar that shows in the standard chat view), replace:
   ```tsx
   <span className="chat-status-bar__model">{activeBot?.model}</span>
   ```
   with:
   ```tsx
   <ModelSelect
     value={selectedModel}
     onChange={setSelectedModel}
     placeholder={getBotDefaultModel(activeBot!) || 'System Default'}
     className="chat-status-bar__model-select"
   />
   ```

   Note: There are two status bars in ChatView.tsx — one for the creation flow (around line 1033) and one for the standard chat view (around line 1214). Only modify the standard chat view status bar (the second one, around line 1214-1228). Leave the creation flow status bar unchanged.

5. **Wire override into handleSend** — in the `handleSend` function, replace the current `wsSendMessage` call (around line 750-759):
   ```typescript
   wsSendMessage(trimmedInput, {
     systemPrompt: activeBot?.systemPrompt,
     botId: activeBot?.id,
     chatId: chatIdToUse ?? undefined,
     model: activeBot?.model,
     models: activeBot?.models,
     ...
   })
   ```
   with:
   ```typescript
   const effectiveModels: BotModels = {
     ...(activeBot?.models || {}),
     default: selectedModel || getBotDefaultModel(activeBot!) || '',
   }
   wsSendMessage(trimmedInput, {
     systemPrompt: activeBot?.systemPrompt,
     botId: activeBot?.id,
     chatId: chatIdToUse ?? undefined,
     model: selectedModel || activeBot?.model,
     models: effectiveModels,
     capabilities: activeBot?.capabilities || defaultCapabilities,
     toolConfigs: activeBot?.toolConfigs,
     replyToId: replyToMessage?.id,
   })
   ```

   Key: An empty `selectedModel` falls back to `getBotDefaultModel(activeBot!)`, preserving the bot's configured default when the user hasn't overridden anything. The `effectiveModels` dict merges the override into the existing multi-model config, which the backend's `build_bot_agent` already reads via `bot_models["default"]`.

**What NOT to do:**
- Do NOT create a new dropdown component — reuse `ModelSelect.tsx` as-is.
- Do NOT store `selectedModel` in Zustand — it's ephemeral UI state, local `useState` is correct.
- Do NOT add a new WS message type — the existing `chat` payload's `models` field is the correct override mechanism.
- Do NOT modify the creation flow status bar (the first status bar around line 1033).
  </action>
  <verify>
Run `cd /mnt/c/Users/Juan/Documents/GitHub/CachiBot/frontend && npm run build` — no TypeScript errors. Verify the import of `ModelSelect` and `getBotDefaultModel` resolves. Check that `effectiveModels` is typed as `BotModels`.
  </verify>
  <done>
`ChatView.tsx` renders a `ModelSelect` dropdown in the chat status bar that defaults to the bot's configured model, resets on bot switch, and passes the selected model as `models.default` override in the `wsSendMessage` call. The frontend build succeeds with no type errors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` in `frontend/` succeeds with no TypeScript errors
2. `npm run lint` in `frontend/` passes (or only has pre-existing warnings unrelated to this change)
3. `ChatView.tsx` imports `ModelSelect` and `getBotDefaultModel`
4. `selectedModel` state is initialized from `getBotDefaultModel` and synced on `activeBotId` change
5. `wsSendMessage` call includes `models: effectiveModels` with the override
</verification>

<success_criteria>
- A model dropdown is rendered in the chat input status bar using the existing `ModelSelect` component
- The dropdown defaults to the bot's configured model and resets when switching bots
- Selecting a different model merges it into the `models.default` field sent over WebSocket
- No new dependencies, no new components, no new WS message types
</success_criteria>

<output>
After completion, create `.planning/phases/01-model-switching/01-01-SUMMARY.md`
</output>
